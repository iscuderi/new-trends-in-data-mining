---
title: "Entrega_descubrimiento_subgrupos"
output: pdf_document
---

#Preguntas:

hacer summary de los campos
1) campos que tienen muchos no reportados: ej weapon (me interesa quedarmelo, por lo que puse "no reportado" ¿se puede hacer eso?), crm codes (como el 85% de los crimenes son de un solo crimen pense en eliminarlos, quizas puedo hacer lo mismo que con weapon)

```{r global_options, include=FALSE}
knitr::opts_chunk$set(knitr::opts_chunk$set(echo = TRUE, comment = NA, message = FALSE, warning = FALSE))

library(rsubgroup)
library(kableExtra)
library(dplyr)
library(lubridate)
library(tidyverse)
```

# 1.Introducción

El objetivo del presente trabajo es analizar el dataset "Crime Data from 2020 to Present" (descarga disponible en: https://data.lacity.org/Public-Safety/Crime-Data-from-2020-to-Present/2nrs-mtv8), mediante técnicas de descubrimiento de subgrupos. El dataset a estudiar refleja los incidentes de delincuencia en la ciudad de Los Ángeles desde 2020 a la actualidad. 
Estos datos se transcriben a partir de informes originales de delitos que se escriben en papel y, por lo tanto, puede haber algunas inexactitudes en los datos. Algunos campos de ubicación con datos faltantes se anotan como (0°, 0°). Los campos de dirección sólo se proporcionan con una precisión de cien manzanas para mantener la privacidad.

# 2.Importado y limpieza de los datos

Procedemos a importar los datos y realizamos e imprimimos los primeros 5 registros, de manera de tener una primera aproximación a los datos:
```{r}
df= read.csv("Crime_Data_from_2020_to_Present.csv", sep =",", header = T)
head(df)
table(df$Vict.Sex)
table(df$Vict.Age)
```

```{r echo=T, results= 'hide'}
str(df)
```


Se observa que el archivo contiene 436.096 registros y 28 variables que se describen a continuación:
  *DR_NO*: Número de registro compuesto por 2 digitos para el año, el ID del área, y 5 digitos.
  *Date Rptd*: Fecha de reporte.
  *DATE OCC*: Fecha del hecho.
  *TIME OCC*: Horario del hecho.
  *AREA*: Identificación de las 21 áreas policiales de LA.
  *AREA NAME*: Nombre del área.
  *Rpt Dist No*: Código de cuatro dígitos que representa una sub-área.
  *Part 1-2*(1): Clasificación por tipo de crimen. Part 1 = crimenes violentos y contra la propiedad.
  Crm Cd: Código del crimen.
  *Crm Cd Desc*: Define el código del crimen.
  *Mocodes*: Modus operandi.
  *Vict Age*: Edad de la víctima.
  *Vict Sex*: Sexo de la víctima.
  *Vict Descent*: Ascendencia de la víctima.
  *Premis Cd*: Tipo de estructura, vehículo, o locación donde el crimen tuvo lugar.
  *Premis Desc*: Define el código de local proporcionado.
  *Weapon Used Cd*: Código del tipo de arma utilizada en el crimen.
  *Weapon Desc*: Define el código del tipo de arma.
  *Status*: Código de estado del caso, IC es la opción por defecto.
  *Status Desc*: Define el código del estado del caso.
  *Crm Cd 1*: Indica el delito cometido. El código del delito 1 es el principal y más grave. Los códigos de delito 2, 3 y 4 son, respectivamente, delitos menos graves. Los números de clase de delito más bajos son más graves.
  *Crm Cd 2*: Puede contener un código para un delito adicional, menos grave que el código del delito 1.
  *Crm Cd 3*: Puede contener un código para un delito adicional menos grave.
  *Crm Cd 4*: Puede contener un código para un delito adicional menos grave.
  *LOCATION*: Dirección del incidente delictivo redondeada a la centena de manzanas más cercana para mantener el anonimato.
  *Cross Street*: Calle transversal redondeada.
  *LAT*: Latitud.
  *LON*: Longitud.
  
(1) para un mayor detalle de la clasificación, ver el *ucr_handbook_2013.pdf*, disponible en la página de origen de los datos.

A continuación, procedemos a eliminar las columnas que no nos resultan de utilidad para el armado de subgrupos. En particular, se han eliminado muchas columnas que contienen códigos de identificación, puesto que se cuenta con columnas con la descripción de los mismos, siendo estos de mayor utilidad. Asimismo se ha eliminado la columna de identificación unívoca de cada registro, así como los campos de fecha de reporte del hecho, la latitud, y la longitud, puesto que no se utilizarán para el armado de subgrupos. Se eliminan también *Crm.Cd.1* ya que duplica información de *Crm.Cd*, y los campos *Crm.Cd.2*, *Crm.Cd.3*, y *Crm.Cd.4*, ya que para la mayoría de los registros no hay valor asignado. *Rpt.Dist-No* se elimina ya que hay demasiados valores únicos para dicho campo (1.183 valores posibles) y ya se cuenta con el campo *AREA.NAME* para identificar geográficamente los hechos.   

A modo de resumen los campos eliminados son: *DR_NO*, *Date.Rptd*, *AREA*, *Rpt.Dist.No*, *Crm.Cd.Desc*, *Premis.Cd*, *Weapon.Weapon.Desc*, *Status*, *Crm.Cd.1*, *Crm.Cd.2*, *Crm.Cd.3*, *Crm.Cd.4*, *Cross.Street*, *LAT*, y *LON*.

```{r}
df2=df
df2$DR_NO= NULL
df2$Date.Rptd = NULL
df2$AREA = NULL
df2$Rpt.Dist.No = NULL
df2$Crm.Cd.Desc = NULL
df2$Premis.Cd = NULL
df2$Weapon.Weapon.Desc = NULL
df2$Status = NULL
df2$Crm.Cd.1 = NULL
df2$Crm.Cd.2 = NULL
df2$Crm.Cd.3 = NULL
df2$Crm.Cd.4 = NULL
df2$Cross.Street = NULL
df2$LAT = NULL
df2$LON = NULL
```

A continuación, se procede a agrupar los datos en rangos que sean de mayor interés.

En primer lugar, se convierte el campo *DATE.OCC* a formato fecha y se extrae únicamente el mes y el año:

```{r}
df2 = df2 %>% mutate(DATE.OCC = sub(" .*", "", DATE.OCC))
df2= df2 %>% mutate(DATE.OCC = as.Date(DATE.OCC, "%m/%d/%Y"))
df2$DATE.OCC <- format(as.Date(df2$DATE.OCC), "%Y-%m")
```

Agrupamos los datos en *madrugada* (00-06), *mañana* (06-12), *tarde* (12-19), y *noche* (19-00):

```{r}
df2= df2 %>% mutate(TIME.OCC = case_when(TIME.OCC >= 0 & TIME.OCC < 600 ~ "madrugada",
                                         TIME.OCC >= 600 & TIME.OCC < 1200 ~ "mañana",
                                         TIME.OCC >= 1200 & TIME.OCC < 1900 ~ "tarde",
                                         TIME.OCC >= 1900 & TIME.OCC <= 2359 ~ "noche"))
  
```

Eliminamos 8 filas que contienen *Vict.Age* igual a -1.
Agrupamos la edad de la víctima en *menor* (0-17), *joven* (18-64), y *mayor* (>65).

```{r}
df2=df2[!(df2$Vict.Age==-1),]
df2= df2 %>% mutate(Vict.Age = case_when(Vict.Age < 18 ~ "menor",
                                         Vict.Age >= 18 & Vict.Age < 65 ~ "joven",
                                         Vict.Age >= 65 ~ "mayor"))
#quitar los que tienen de edad 0
```

En el caso de las armas se clasifican en *arma_de_fuego* (100-199), *cortante* (200-299), *otras_peligrosas* (300-399), *fisico* (400-499), *desconocida_y_otras* (500-599), y *no_reportado*.

```{r}
df2= df2 %>% mutate(Weapon.Used.Cd2 = case_when(Weapon.Used.Cd >= 100 & Weapon.Used.Cd <= 199 ~ "arma_de_fuego",
                                         Weapon.Used.Cd >= 200 & Weapon.Used.Cd <= 299 ~ "cortante",
                                         Weapon.Used.Cd >= 300 & Weapon.Used.Cd <= 399 ~ "otras_peligrosas",
                                         Weapon.Used.Cd >= 400 & Weapon.Used.Cd <= 499 ~ "fisico",
                                         Weapon.Used.Cd >= 500 & Weapon.Used.Cd <= 599 ~ "desconocida_y_otras",
                                         TRUE ~ "no_reportado"))
```



A continuación se comprueba no hay presencia de *NA`s*

```{r}
colSums(is.na(df))
colSums(is.na(df2))
```
Agrupamos los *Crm.Cd*. En el caso de *Violencia doméstica*, si bien se trata de un subnivel dentro de *Asalto agravado* y *Asalto simple*, debido a su relevancia, se ha decidido elevarla en su nivel de jerarquía.
La identificación *VC* corresponde a crímenes violentos, mientras que *PC* son crímenes contra la propiedad.

Si bien para clasificar gran parte de los datos se ha utilizado el documento *UCR-COMPSTAT062618.pdf*, hay 106.682 registros no incluidos. Se ha procedido a realizar una inspección manual de dichos códigos de manera de poder asignarlos correctamente.
A continuación se los detalla:
      Códigos 740, 745

```{r}
df2=df

df2= df2 %>% mutate(Crm.Cd2 = case_when(Crm.Cd == 110  | Crm.Cd == 113 ~ "VC_homicidio",
                                         Crm.Cd == 121 | Crm.Cd == 122 | Crm.Cd == 815 | Crm.Cd == 820 | Crm.Cd == 821 ~ "violacion",
                                         Crm.Cd == 210 | Crm.Cd == 220 ~ "VC_robo",
                                         Crm.Cd == 510 | Crm.Cd == 520 | Crm.Cd == 433 ~ "VC_robo_vehiculo",
                                         Crm.Cd == 230 | Crm.Cd == 231 | Crm.Cd == 235 ~ "VC_asalto_agravado",
                                         Crm.Cd == 236 | Crm.Cd == 250 | Crm.Cd == 251 | Crm.Cd == 761 | Crm.Cd == 926 ~ "VC_violencia_domestica_asalto_agravado",
                                         Crm.Cd == 435 | Crm.Cd == 436 | Crm.Cd == 437 | Crm.Cd == 622 | Crm.Cd == 623 | Crm.Cd == 624 | Crm.Cd == 625 ~ "VC_asalto_simple",
                                         Crm.Cd == 626 | Crm.Cd == 627 | Crm.Cd == 647 | Crm.Cd == 763 | Crm.Cd == 928 | Crm.Cd == 930 ~ "VC_violencia_domestica_asalto_simple",
                                         Crm.Cd == 310 | Crm.Cd == 320 ~ "PC_robo",
                                         Crm.Cd == 330 | Crm.Cd == 331 | Crm.Cd == 410 | Crm.Cd == 420 | Crm.Cd == 421 ~ "PC_robo_interior_vehiculo",
                                         Crm.Cd == 350 | Crm.Cd == 351 | Crm.Cd == 352 | Crm.Cd ==353 | Crm.Cd ==450 | Crm.Cd == 451 | Crm.Cd == 452 | Crm.Cd == 453 ~ "PC_robo_personal",
                                         Crm.Cd == 341 | Crm.Cd == 343 | Crm.Cd == 345 | Crm.Cd == 440 | Crm.Cd == 441 | Crm.Cd == 442 | Crm.Cd ==443 | Crm.Cd == 444 | Crm.Cd ==445 | Crm.Cd == 470 | Crm.Cd == 471 | Crm.Cd == 472 | Crm.Cd == 473 | Crm.Cd == 474 | Crm.Cd == 475 | Crm.Cd == 480 | Crm.Cd == 485 | Crm.Cd == 487 | Crm.Cd == 491 ~ "PC_otros_robos"))

df2[1:1000,c('Crm.Cd', 'Crm.Cd2', 'Crm.Cd.Desc', 'Part.1.2')]
head(df2)
unique(df2[c("Crm.Cd")])
table(df2$Crm.Cd)

```


```{r}
unique(df2[c("Crm.Cd")]) #hay que ver los códigos para ver si se puede agruparlos 
unique(df2[c("Mocodes")]) #hay que ver los códigos para ver si se puede agruparlos
head(df,600)
```


Como último paso en este apartado, convertimos las columnas

```{r}
head(df2)
table(df2$Vict.Descent)
df2$AREA.NAME = as.factor(df2$AREA.NAME)
df2$Crm.Cd = as.factor(df2$Crm.Cd)
df2$TIME.OCC = as.factor(df2$TIME.OCC)
df2$Vict.Sex = as.factor(df2$Vict.Sex)
df2$Vict.Age = as.factor(df2$Vict.Age)
df2$Vict.Descent = as.factor(df2$Vict.Descent) #limpiar


df2$Crm.Cd2 = as.factor(df2$Crm.Cd2)
df2$ = as.factor(df2$)
df2$ = as.factor(df2$)
df2$ = as.factor(df2$)
df2$ = as.factor(df2$)
df2$ = as.factor(df2$)
df2$ = as.factor(df2$)
df2$ = as.factor(df2$)
df2$ = as.factor(df2$)
df2$ = as.factor(df2$)
df2$ = as.factor(df2$)
df2$ = as.factor(df2$)
df2$ = as.factor(df2$)
```



# 3.Análisis exploratorio

#Hacemos algunos gráficos. Ejemplos: histograma de crimenes por horas, por sexo, por franjas horarias (madrugada, mañana, tarde, y noche). Crime code, área, crimenes por mes y año (saco los dias)

# 4.Descubrimiento de subgrupos

```{r}
library(rsubgroup)
head(df2)
df2=df2[1:1000,]
summary(df2)
table(df2$Crm.Cd2)
names(df2)
resultado=DiscoverSubgroups(df2,as.target("Crm.Cd2", "violacion"),new("SDTaskConfig",attributes=c("AREA.NAME","TIME.OCC","Vict.Sex","Vict.Age","Vict.Descent")))
ToDataFrame(resultado)
```


#Preguntas a responder: ¿Ciertos tipos de crimenes los sufren personas de cierta edad? de cierto género? ¿hay barrios que en ciertas franjas horarias tengan más crimenes?